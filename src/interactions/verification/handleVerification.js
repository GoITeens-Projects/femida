const useSocket = require("../../utils/useSocket");

module.exports = async function handleVerification(msg) {
  if (!msg.content.toLowerCase().startsWith("verify")) return;
  function validateEmail(email) {
    const regExp =
      /^(([^<>()[\].,;:\s@"]+(\.[^<>()[\].,;:\s@"]+)*)|(".+"))@(([^<>()[\].,;:\s@"]+\.)+[^<>()[\].,;:\s@"]{2,})$/iu;
    return regExp.test(email);
  }
  const email = msg.content.slice(7, msg.content.length);
  if (!validateEmail(email) || email.length < 3 || email.length > 259) {
    return await msg.reply("–¢–∞–∫–æ—ó –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ—ó –ø–æ—à—Ç–∏ –Ω–µ —ñ—Å–Ω—É—î((");
  }
  msg.react("üíô");
  const waitMsg = await msg.channel.send("–ó–∞—á–µ–∫–∞–π —Ç—Ä–æ—Ö–∏..");
  const userObj = {
    email,
    id: msg.author.id,
    avatar: msg.author.displayAvatarURL({ dynamic: true }) || "",
    username: msg.author.username,
    globalName: msg.author.globalName,
  };
  try {
    const resp = await fetch("http://" + process.env.FEMIDA_API + "/verify", {
      method: "POST",
      body: JSON.stringify(userObj),
      headers: {
        "Content-Type": "application/json; charset=UTF-8",
        Authorization: `Bearer ${process.env.FEMIDA_API_TOKEN}`,
      },
    });
    const data = await resp.json();
    waitMsg.edit(data?.message);
    if (resp.status === 400) {
      msg.react("üö©");
    }
  } catch (err) {
    console.log(err);
    msg.react("üö©");
    waitMsg.edit("–¢—Ä–∞–ø–∏–ª–∞—Å—è –¥–∏–≤–Ω–∞ –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π –ø—ñ–∑–Ω—ñ—à–µ");
  }
};
